<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Theme Variables: White and Green */
        :root {
            --primary: #10b981; /* Green for primary actions/active state */
            --primary-dark: #059669; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; /* Yellow/Orange for Due state */
            --info: #3b82f6; /* Blue for adjustment/info */
            --bg: #f7f9fa; /* Light background */
            --card: #ffffff; 
            --text: #1f2937;
            --text-light: #6b7280;
            --border-color: #e5e7eb;
        }

        /* Global Reset and Typography */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: var(--bg);
            color: var(--text);
            padding: 30px 15px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 1100px;
        }
        .card {
            background: var(--card);
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
        h1 {
            color: var(--primary-dark);
            font-size: 1.8rem;
            font-weight: 800;
        }
        h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
        }

        /* Layout */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
        }
        .controls {
            display: flex;
            gap: 10px;
        }
        .card-grid {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 30px;
        }
        .section {
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px; 
        }
        .col {
            flex: 1;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        /* Buttons */
        .btn {
            padding: 10px 18px;
            border-radius: 9px;
            border: 1px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap; 
            font-size: 0.95rem;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }
        .btn-ghost {
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--border-color);
        }
        .btn-ghost:hover:not(:disabled) {
            background: #f1f5f9;
        }
        .btn-danger {
            background: var(--danger);
            color: #fff;
        }
        .btn-danger:hover:not(:disabled) {
            background: #c33;
        }
        .btn.active-role {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }
        .btn.active-role:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        /* Form Elements */
        .label {
            display: block;
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 0.95rem;
            color: var(--text-light);
        }
        .input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 9px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 1rem;
            color: var(--text);
            background-color: #fcfdfe;
        }
        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .small {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 6px;
            line-height: 1.4;
        }
        .alert {
            padding: 12px;
            border-radius: 9px;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }
        .alert.success {
            background-color: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .alert.error {
            background-color: #fef2f2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* Dashboard/Indicator */
        .role-indicator {
            padding: 12px 20px;
            border-radius: 12px;
            background: #d1fae5; /* Light green background */
            border: 1px solid #a7f3d0;
            margin-bottom: 24px;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Credit Box - Dynamic Styling */
        .credit-box {
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 10px;
            background: #ecfdf5; 
            border: 1px solid #a7f3d0;
            color: var(--success);
        }
        .credit-box.due-state {
            background: #fef3c7; 
            border: 1px solid #fde68a;
            color: var(--warning);
        }
        .big {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .status {
            display: inline-block;
            padding: 7px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem; 
            text-transform: uppercase;
        }
        .status-active {
            background: var(--primary);
            color: #fff;
        }
        .status-deactive {
            background: var(--danger);
            color: #fff;
        }
        
        /* --- Modal Styles --- */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px); 
        }
        .modal-content {
            background-color: var(--card);
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px; 
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: fadeIn 0.3s; 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .close-btn {
            color: var(--text-light);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 25px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: var(--danger);
        }
        /* New History Item Layout */
        .history-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr; /* Date/Type, Adjustments, Final Amount */
            gap: 15px;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-header {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr;
            gap: 15px;
            font-weight: 700;
            font-size: 1rem;
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary);
            padding: 5px 0 10px 0;
            margin-bottom: 0px;
        }
        .history-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.85rem;
            color: var(--text);
        }
        .history-details span {
            display: block;
        }
        .history-label {
            color: var(--text-light);
            font-weight: 500;
        }
        .history-amount-final {
            font-weight: 800;
            text-align: right;
            font-size: 1.1rem;
        }
        .no-records {
            text-align: center;
            color: var(--text-light);
            padding: 20px;
            font-style: italic;
        }

        /* Media Queries */
        @media(max-width: 1000px) {
            .controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        @media(max-width: 880px) {
            .card-grid {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .controls {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }
            .history-header, .history-item {
                grid-template-columns: 1fr 1fr; /* Stack adjustment column */
            }
            .history-item-primary { order: 1; }
            .history-details { order: 3; margin-top: 10px; }
            .history-amount-final { order: 2; text-align: right; }
        }
        @media(max-width: 500px) {
            .row {
                flex-direction: column;
                align-items: stretch;
            }
            .btn {
                width: 100%;
            }
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <div class="header">
            <h1><i class="fas fa-user-cog"></i> Admin Panel</h1> 
            <div class="controls">
                <button id="btnManageDev" class="btn btn-ghost"><i class="fas fa-user-tie"></i> Developer</button>
                <button id="btnManageManager" class="btn btn-ghost"><i class="fas fa-user-shield"></i> Manager</button>
                <button id="btnManageVendor" class="btn btn-ghost"><i class="fas fa-store"></i> Vendor</button>
            </div>
        </div>

        <div class="card-grid">
            <div>
                <div id="roleIndicator" class="role-indicator">
                    </div>
                <div class="section" id="setupSection">
                    <h3 id="setupTitle">Role Details</h3>
                    
                    <label class="label">Name *</label>
                    <input id="nameInput" class="input" placeholder="Full name" />

                    <label class="label">Email *</label>
                    <input id="emailInput" class="input" placeholder="email@example.com" />

                    <label class="label">Phone</label>
                    <input id="phoneInput" class="input" placeholder="+91-XXXXXXXXXX" />
                    
                    <div class="actions">
                        <button id="saveBtn" class="btn btn-primary"><i class="fas fa-save"></i> Save / Update Details</button>
                        <button id="deleteBtn" class="btn btn-danger" style="display: none;"><i class="fas fa-trash-alt"></i> Delete Role</button>
                    </div>

                    <div id="setupAlert" class="alert"></div>
                </div>
            </div>

            <div class="section" id="managementSection">
                <h3>Vendor Finance Actions</h3>
                <div id="financeBox" class="credit-box">
                    <div class="small" id="displayTitle">Current Credits (Wallet)</div>
                    <div id="currentValue" class="big">--</div>
                    <div><span id="statusBadge" class="status status-deactive">LOADING...</span></div>
                    
                    <div class="small" style="margin-top:8px">Available Credit: <strong id="totalCreditDisplay">--</strong></div>
                    <div class="small">Total Due: <strong id="totalDueDisplay">--</strong></div>
                </div>

                <div style="margin-top:20px" id="vendorControls">
                    <label class="label" style="margin-top:0;">Payment / Recharge</label>
                    <div class="row">
                        <input id="addCreditsInput" class="input col" type="number" min="1" placeholder="Payment Amount (₹)" />
                        <button id="addCreditsBtn" class="btn btn-primary"><i class="fas fa-wallet"></i> Pay & Add Credit</button>
                    </div>

                    <label class="label">Admin Overrides & Status</label>
                    <div class="row">
                        <button id="zeroCreditsBtn" class="btn btn-ghost"><i class="fas fa-hand-holding-usd"></i> Set Credit to Zero</button>
                        <button id="vendorToggleBtn" class="btn btn-ghost"><i class="fas fa-toggle-on"></i> Toggle Active Status</button>
                    </div>

                    <div class="row">
                        <button id="viewHistoryBtn" class="btn btn-primary" style="flex:1;"><i class="fas fa-history"></i> View Payment History</button>
                    </div>
                    
                    <div class="row">
                        <button id="forceSyncBtn" class="btn btn-ghost" style="flex:1;"><i class="fas fa-sync"></i> Force Refresh Data</button>
                    </div>
                </div>

                <div id="moduleAlert" class="alert"></div>
            </div>
        </div> 
    </div>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2 style="color:var(--primary); margin-bottom: 20px;"><i class="fas fa-receipt"></i> Vendor Payment History (Last 50 Records)</h2>
        
        <div class="history-header">
            <span>Date & Type</span>
            <span>Due/Credit Adjustment</span>
            <span style="text-align: right;">Amount Paid</span>
        </div>
        
        <div id="historyRecords">
            </div>
    </div>
</div>

<script type="module">
// Firebase RTDB Imports
import { firebaseConfig } from "../Database/Database.js"; 
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { 
    getDatabase, 
    ref as dbRef, 
    get, 
    set, 
    update, 
    remove, 
    onValue
} from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

// Firebase Initialization
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* UI refs */
const nameInput = document.getElementById('nameInput');
const emailInput = document.getElementById('emailInput');
const phoneInput = document.getElementById('phoneInput');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');
const setupAlert = document.getElementById('setupAlert');

const financeBox = document.getElementById('financeBox');
const displayTitle = document.getElementById('displayTitle');
const currentValue = document.getElementById('currentValue');
const totalCreditDisplay = document.getElementById('totalCreditDisplay');
const totalDueDisplay = document.getElementById('totalDueDisplay');
const statusBadge = document.getElementById('statusBadge');
const addCreditsInput = document.getElementById('addCreditsInput');
const addCreditsBtn = document.getElementById('addCreditsBtn');
const zeroCreditsBtn = document.getElementById('zeroCreditsBtn');
const vendorToggleBtn = document.getElementById('vendorToggleBtn');
const moduleAlert = document.getElementById('moduleAlert');
const forceSyncBtn = document.getElementById('forceSyncBtn'); 

const btnManageDev = document.getElementById('btnManageDev');
const btnManageManager = document.getElementById('btnManageManager');
const btnManageVendor = document.getElementById('btnManageVendor');
const roleIndicator = document.getElementById('roleIndicator');

// Modal Refs
const historyModal = document.getElementById('historyModal');
const closeBtn = document.querySelector('.close-btn');
const viewHistoryBtn = document.getElementById('viewHistoryBtn');
const historyRecords = document.getElementById('historyRecords');

/* Global State */
let currentRole = 'developer';
let vendorData = null;

/* References for listeners and updates */
const vendorRef = dbRef(db, 'roles/vendor');
const paymentsRef = dbRef(db, 'vendorPayments');

/* Helper: Show UI alerts */
function showAlert(el, txt, kind='success', timeout=3000){
    el.textContent = txt;
    el.classList.remove('success','error');
    el.classList.add(kind);
    el.style.display = 'block';
    if(timeout) setTimeout(()=>{ el.style.display='none'; }, timeout);
}
function hideAlert(el){ el.style.display='none'; }

/* Real-time listener for vendor data */
function setupVendorRealtime(){
    onValue(vendorRef, snap=>{
        vendorData = snap.exists() ? snap.val() : null;
        updateCreditDisplayRealtime(); 
        
        if(currentRole === 'vendor' && vendorData){
             nameInput.value = vendorData.name || '';
             emailInput.value = vendorData.email || '';
             phoneInput.value = vendorData.phone || '';
        }
    });
}

/** * Update credit dashboard UI
 * Logic: If DUE > 0, display DUE. If DUE == 0, display CREDITS.
 */
function updateCreditDisplayRealtime(){
    if(!vendorData){
        currentValue.innerHTML = '<i class="fas fa-minus-circle"></i> --';
        displayTitle.textContent = 'Vendor Status';
        totalCreditDisplay.textContent = '--';
        totalDueDisplay.textContent = '--';
        statusBadge.textContent = 'NO VENDOR';
        statusBadge.className = 'status status-deactive';
        vendorToggleBtn.textContent = 'Toggle Active';
        financeBox.className = 'credit-box'; 
        viewHistoryBtn.disabled = true;
        return;
    }
    
    viewHistoryBtn.disabled = false;
    const deu = Number(vendorData.deu || 0);
    const credits = Number(vendorData.credits || 0);
    const isActiveFlag = !!vendorData.isActive;
    
    totalCreditDisplay.textContent = credits; 
    totalDueDisplay.textContent = deu; 
    vendorToggleBtn.textContent = isActiveFlag ? 'Deactivate' : 'Activate'; 

    // --- MAIN DISPLAY LOGIC ---
    if(deu > 0){
        // DUE state
        displayTitle.textContent = 'Current DUE (Needs Payment)';
        currentValue.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> ₹${deu}`;
        financeBox.classList.add('due-state');
        financeBox.style.color = 'var(--warning)';
    } else {
        // CREDIT state
        displayTitle.textContent = 'Available Credits (Wallet)';
        currentValue.innerHTML = `<i class="fas fa-wallet" style="color:var(--success)"></i> ₹${credits}`;
        financeBox.classList.remove('due-state');
        financeBox.style.color = 'var(--success)';
    }
    
    // Status Badge
    if(isActiveFlag){
        statusBadge.textContent = deu > 0 ? 'ACTIVE (DUE)' : 'ACTIVE';
        statusBadge.className = 'status status-active';
    } else {
        statusBadge.textContent = 'DEACTIVATED';
        statusBadge.className = 'status status-deactive';
    }
}

/* Load role data */
async function loadRoleData(role){
    hideAlert(setupAlert);
    const roleRef = dbRef(db, 'roles/' + role);
    
    try{
        const snap = await get(roleRef);
        const dataExists = snap.exists();

        const d = dataExists ? snap.val() : {};

        nameInput.value = d.name || '';
        emailInput.value = d.email || '';
        phoneInput.value = d.phone || '';
        
        // **FIX: Set Save/Update button text**
        saveBtn.innerHTML = dataExists ? '<i class="fas fa-save"></i> Update Details' : '<i class="fas fa-plus-circle"></i> Save Details';

        // **FIX: Hide Delete button for Developer**
        if (role === 'developer') {
            deleteBtn.style.display = 'none';
        } else {
            deleteBtn.style.display = dataExists ? 'inline-flex' : 'none'; // Only show if data exists
        }

        if(dataExists){
             showAlert(setupAlert, `Loaded existing ${role} data`, 'success', 2000);
        } else {
             showAlert(setupAlert, `Ready to create new ${role}`, 'success', 2000);
        }
    }catch(err){
         console.error("Error loading role data:", err);
         showAlert(setupAlert, `Error loading ${role} data`, 'error', 5000);
         saveBtn.innerHTML = '<i class="fas fa-save"></i> Save / Update Details'; // Fallback
         deleteBtn.style.display = 'none';
    }
}

/* Switch between roles */
function setRoleView(role){
    currentRole = role;
    localStorage.setItem('admin_selected_role', role);

    btnManageDev.classList.remove('active-role');
    btnManageManager.classList.remove('active-role');
    btnManageVendor.classList.remove('active-role');
    
    const isVendor = role === 'vendor';
    
    // Set Active Button
    if(role === 'vendor'){
        btnManageVendor.classList.add('active-role');
    } else if (role === 'manager') {
        btnManageManager.classList.add('active-role');
    } else { 
        btnManageDev.classList.add('active-role');
    }

    // Toggle Vendor-specific UI elements
    document.getElementById('managementSection').style.opacity = isVendor ? '1' : '0.5';
    document.getElementById('vendorControls').style.pointerEvents = isVendor ? 'auto' : 'none';
    
    // Set Indicator 
    let icon = '';
    let roleTitle = role.charAt(0).toUpperCase() + role.slice(1);

    if(role === 'vendor'){
        icon = '<i class="fas fa-store"></i>';
    } else if (role === 'manager'){
        icon = '<i class="fas fa-user-shield"></i>';
    } else { 
        icon = '<i class="fas fa-user-tie"></i>';
    }

    roleIndicator.innerHTML = `${icon} <strong>${roleTitle}</strong>`;
    document.getElementById('setupTitle').textContent = `${roleTitle} Details`; 

    loadRoleData(role);
}

/* Save role (create or update) */
saveBtn.addEventListener('click', async (e)=>{
    e.preventDefault();
    hideAlert(setupAlert);
    const role = currentRole;
    const roleRef = dbRef(db, 'roles/' + role);
    
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const phone = phoneInput.value.trim() || 'N/A';

    if(!name || !email){ showAlert(setupAlert, 'Name and Email are required', 'error'); return; }
    
    saveBtn.disabled = true;

    try{
        const snap = await get(roleRef);
        const dataExists = snap.exists();
        const now = new Date().toISOString();
        let message = '';

        if(!dataExists){
            // Create Logic (SAVE)
            const payload = { name, email, phone, createdAt: now, updatedAt: now };
            if(role === 'vendor'){
                payload.deu = 0;
                payload.credits = 0;
                payload.isActive = false; 
            }
            await set(roleRef, payload);
            message = 'Created ' + role + ' successfully';
        } else {
            // Update Logic (UPDATE)
            const updates = { name, email, phone, updatedAt: now };
            await update(roleRef, updates);
            message = 'Updated ' + role + ' successfully';
        }
        
        showAlert(setupAlert, message, 'success', 3000);
        // Force reload role to update button texts
        loadRoleData(role); 
    }catch(err){
        console.error(err);
        showAlert(setupAlert, 'Error: ' + (err.message||'Unknown error occurred'), 'error', 5000);
    } finally {
        saveBtn.disabled = false;
    }
});

/* Delete role node */
deleteBtn.addEventListener('click', async ()=>{
    hideAlert(setupAlert);
    const role = currentRole;
    if(role === 'developer'){ // Double check logic
        showAlert(setupAlert, 'Developer role cannot be deleted.', 'error', 3000);
        return;
    }
    
    const roleRef = dbRef(db, 'roles/' + role);

    const snap = await get(roleRef);
    if(!snap.exists()){
        showAlert(setupAlert, `The ${role} does not exist to delete.`, 'error', 3000);
        return;
    }

    if(!confirm(`Are you sure you want to permanently delete the ${role.toUpperCase()}? This action cannot be undone.`)) return;
    
    deleteBtn.disabled = true;

    try{
        await remove(roleRef);
        showAlert(setupAlert, role + ' removed successfully', 'success', 3000);
        
        nameInput.value=''; emailInput.value=''; phoneInput.value=''; 
        
        setRoleView('developer'); // Redirect to a safe default role
    }catch(err){
        console.error(err);
        showAlert(setupAlert, 'Delete failed: ' + (err.message||err), 'error', 5000);
    } finally {
        deleteBtn.disabled = false;
    }
});

/** * CORE LOGIC: Payment, Due Adjustment, Credit Update, and Full Proof Record (Vendor Only)
 * Vender is ACTIVATED only if credit > 0.
 */
addCreditsBtn.addEventListener('click', async ()=>{
    hideAlert(moduleAlert);
    if(currentRole !== 'vendor'){ showAlert(moduleAlert, 'Payment actions are only for the Vendor role.', 'error'); return; }
    if(!vendorData){ showAlert(moduleAlert,'No vendor exists','error'); return; }
    
    const amountPaid = Number(addCreditsInput.value);
    if(!amountPaid || amountPaid <= 0 || !Number.isInteger(amountPaid)){ 
        showAlert(moduleAlert,'Enter a valid positive integer amount paid','error'); 
        return; 
    }
    
    const currentCredits = Number(vendorData.credits || 0);
    const currentDue = Number(vendorData.deu || 0);
    
    if(!confirm(`Payment: ₹${amountPaid}. Proceed to clear Due and update Credits?`)) return;
    
    addCreditsBtn.disabled = true;

    try{
        let creditAdded = 0;
        let dueCleared = 0; 
        let newDue = currentDue;
        const now = new Date().toISOString();
        let message = '';
        
        // --- CORE LOGIC: DUE ADJUSTMENT ---
        if(currentDue > 0){
            if(amountPaid >= currentDue){
                const remainingAmount = amountPaid - currentDue;
                dueCleared = currentDue;
                newDue = 0; 
                creditAdded = remainingAmount; 
                message = `Due of ₹${currentDue} cleared. ₹${remainingAmount} added to Credit.`;
            } else {
                dueCleared = amountPaid;
                newDue = currentDue - amountPaid;
                creditAdded = 0; 
                message = `Paid ₹${amountPaid}. Due partially cleared. Remaining Due: ₹${newDue}.`;
            }
        } else {
            newDue = 0;
            creditAdded = amountPaid;
            message = `No Due. ₹${amountPaid} added directly to Credit.`;
        }
        
        // Final updates for Vendor role
        const newCredits = currentCredits + creditAdded;
        const updates = {
            credits: newCredits, 
            deu: newDue,                          
            isActive: newCredits > 0 ? true : vendorData.isActive, // Activate if credit > 0                     
            updatedAt: now
        };
        
        // Payment Record (FULL PROOF STRUCTURE)
        const paymentId = 'P_' + Date.now();
        const paymentRecord = {
            vendorId: 'vendor', 
            timestamp: now,
            amountPaid: amountPaid,
            type: 'Payment/Recharge',
            dueBefore: currentDue,
            creditBefore: currentCredits, 
            dueCleared: dueCleared, 
            creditAdded: creditAdded, 
            dueAfter: newDue,
            creditAfter: newCredits,
            processedBy: 'AdminPanel'
        };
        
        // Atomic updates
        await update(vendorRef, updates);
        await set(dbRef(db, 'vendorPayments/' + paymentId), paymentRecord);
        
        addCreditsInput.value = '';
        showAlert(moduleAlert, message, 'success', 6000);
        
    }catch(err){
        console.error(err);
        showAlert(moduleAlert,'Failed: ' + (err.message||err), 'error', 5000);
    } finally {
        addCreditsBtn.disabled = false;
    }
});

/* Admin Override: Set Credit to Zero (Vendor Only)
 * Vendor is DEACTIVATED when credit is set to zero.
 */
zeroCreditsBtn.addEventListener('click', async ()=>{
    hideAlert(moduleAlert);
    if(currentRole !== 'vendor'){ showAlert(moduleAlert, 'Credit actions are only for the Vendor role.', 'error'); return; }
    if(!vendorData){ showAlert(moduleAlert,'No vendor exists','error'); return; }
    
    if(!confirm('Are you sure you want to set the Vendor\'s CURRENT CREDIT (Wallet Balance) to ₹0? This will also DEACTIVATE the vendor.')) return;
    
    zeroCreditsBtn.disabled = true;

    try{
        const updates = { 
            credits: 0, 
            isActive: false, 
            updatedAt: new Date().toISOString() 
        };
        await update(vendorRef, updates);
        
        const paymentId = 'A_' + Date.now();
        const paymentRecord = {
            vendorId: 'vendor', 
            timestamp: new Date().toISOString(),
            amountPaid: 0,
            type: 'Admin Override: Zero Credit',
            creditBefore: Number(vendorData.credits || 0), 
            creditAfter: 0,
            processedBy: 'AdminPanel'
        };
        await set(dbRef(db, 'vendorPayments/' + paymentId), paymentRecord);
        
        showAlert(moduleAlert, 'Vendor Credit set to ₹0 and DEACTIVATED successfully', 'success', 3500);
    }catch(err){
        console.error(err);
        showAlert(moduleAlert,'Failed: ' + (err.message||err), 'error', 5000);
    } finally {
        zeroCreditsBtn.disabled = false;
    }
});


/* Vendor action: Toggle Active Status (Vendor Only) */
vendorToggleBtn.addEventListener('click', async ()=>{
    hideAlert(moduleAlert);
    if(currentRole !== 'vendor'){ showAlert(moduleAlert, 'Status actions are only for the Vendor role.', 'error'); return; }
    if(!vendorData){ showAlert(moduleAlert,'No vendor exists','error'); return; }

    const isCurrentlyActive = !!vendorData.isActive;
    const credits = Number(vendorData.credits || 0);
    
    // Safety check for activation (must have credit > 0)
    if(!isCurrentlyActive && credits <= 0){
        showAlert(moduleAlert, 'Cannot manually activate: Credit is ₹0. Add credit first.', 'error', 4000);
        return;
    }
    
    vendorToggleBtn.disabled = true;

    try{
        const newFlag = !isCurrentlyActive;
        const updates = { isActive: newFlag, updatedAt: new Date().toISOString() };
        await update(vendorRef, updates);
        showAlert(moduleAlert, 'Vendor is now ' + (newFlag ? 'ACTIVE' : 'DEACTIVATED') + ' successfully', 'success', 2500);
    }catch(err){
        console.error(err);
        showAlert(moduleAlert,'Toggle failed: ' + (err.message||err), 'error', 5000);
    } finally {
        vendorToggleBtn.disabled = false;
    }
});

/* History Modal Functions (Full Proof & Detailed) */
viewHistoryBtn.addEventListener('click', async () => {
    hideAlert(moduleAlert);
    if (currentRole !== 'vendor' || !vendorData) {
        showAlert(moduleAlert, 'No active vendor selected.', 'error', 3000);
        return;
    }

    try {
        // Fetch all payment data
        const snapshot = await get(paymentsRef);
        
        historyRecords.innerHTML = '';
        
        if (snapshot.exists()) {
            const payments = [];
            
            snapshot.forEach(childSnap => {
                payments.push(childSnap.val());
            });
            
            // Sort the data by descending timestamp (latest first)
            payments.sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp); 
            });

            // Show only the latest 50 records
            const recentPayments = payments.slice(0, 50); 
            
            if(recentPayments.length === 0){
                historyRecords.innerHTML = '<div class="no-records">No payment records found.</div>';
            } else {
                recentPayments.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    
                    const date = new Date(record.timestamp).toLocaleString('en-IN', {
                        year: 'numeric', month: 'short', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit'
                    });
                    
                    let amountText = '';
                    let amountColor = '';
                    let transactionType = record.type || 'Transaction';
                    
                    // --- Due/Credit Adjustment Details ---
                    let adjustmentHtml = '';
                    
                    if (record.dueCleared > 0) {
                        // Due cleared (Paid out of the amountPaid for due)
                        adjustmentHtml += `<span style="color:var(--danger)"><i class="fas fa-minus-circle"></i> ₹${record.dueCleared} (Due Cleared)</span>`;
                    }
                    if (record.creditAdded > 0) {
                        // Credit added (Remaining amount after due is cleared, or total amount if no due)
                        adjustmentHtml += `<span style="color:var(--primary-dark)"><i class="fas fa-plus-circle"></i> ₹${record.creditAdded} (Credit Added)</span>`;
                    }
                    
                    if (transactionType.includes('Zero Credit')) {
                         adjustmentHtml = `<span style="color:var(--danger)">Credit Reset: ${record.creditBefore || 0} → ${record.creditAfter || 0}</span>`;
                    }
                    if (!adjustmentHtml && record.amountPaid === 0) {
                        adjustmentHtml = `<span class="history-label">No Wallet Change</span>`;
                    }

                    // --- Final Paid Amount ---
                    if(record.amountPaid > 0) {
                        amountText = `₹${record.amountPaid}`;
                        amountColor = 'var(--primary-dark)';
                    } else {
                        amountText = '₹0';
                        amountColor = 'var(--text-light)';
                    }
                    
                    // Main item structure
                    item.innerHTML = `
                        <div class="history-item-primary">
                            <span class="history-item-date">${date}</span>
                            <div style="font-weight: 600; font-size: 0.95rem; color: var(--text); margin-top: 2px;">${transactionType}</div>
                        </div>
                        <div class="history-details">
                            ${adjustmentHtml}
                            <span class="history-label">Balance After: ${record.creditAfter || 0} Cr. | ${record.dueAfter || 0} Due</span>
                        </div>
                        <div class="history-amount-final" style="color:${amountColor}">
                            ${amountText}
                        </div>
                    `;
                    historyRecords.appendChild(item);
                });
            }
        } else {
            historyRecords.innerHTML = '<div class="no-records">No payment records found.</div>';
        }

        // Show the modal
        historyModal.style.display = 'flex'; 
    } catch (err) {
        console.error("Failed to load history:", err);
        historyRecords.innerHTML = '<div class="no-records" style="color:var(--danger)">Error loading records. Check console for details.</div>';
        historyModal.style.display = 'flex';
    }
});

closeBtn.addEventListener('click', () => {
    historyModal.style.display = 'none';
});

// Close modal when clicking outside
window.addEventListener('click', (event) => {
    if (event.target === historyModal) {
        historyModal.style.display = 'none';
    }
});

/* Force refresh data */
forceSyncBtn.addEventListener('click', async ()=>{
    hideAlert(moduleAlert);
    forceSyncBtn.disabled = true;

    try{
        await loadRoleData(currentRole); 
        if(currentRole === 'vendor') updateCreditDisplayRealtime(); 
        
        showAlert(moduleAlert,'Full data refreshed successfully', 'success', 1500);
    }catch(err){
        console.error(err);
        showAlert(moduleAlert,'Refresh failed: ' + (err.message||err),'error',2000);
    } finally {
        forceSyncBtn.disabled = false;
    }
});


/* Switch view buttons */
btnManageDev.addEventListener('click', ()=>{ setRoleView('developer'); });
btnManageManager.addEventListener('click', ()=>{ setRoleView('manager'); }); 
btnManageVendor.addEventListener('click', ()=>{ setRoleView('vendor'); });

/* Start Application */
(function init(){
    setupVendorRealtime();
    
    const savedRole = localStorage.getItem('admin_selected_role') || 'developer';
    setRoleView(savedRole);
})();
</script>
</body>
</html>
