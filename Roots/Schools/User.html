<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>School Manager</title>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Remix Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />

    <style>
        :root {
            --primary: #4A90E2;
            --primary-dark: #357ABD;
            --secondary: #6B7280;
            --dark: #1F2937;
            --text-dark: #374151;
            --text-light: #6B7280;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #F0F4F8;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            --radius-lg: 16px;
            --radius-md: 8px;
        }

        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text-dark);
            min-height: 100vh;
        }

        .ri-icon {
            line-height: 1;
        }

        /* NAVBAR */
        .navbar {
            background: var(--card-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .navbar h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .badges {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .badge {
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }

        .badge .ri-icon {
            font-size: 1.2rem;
        }

        .badge.info {
            background: #E6F0FF;
            border-color: var(--primary);
            color: var(--primary);
        }

        .badge.success {
            background: #D1FAE5;
            border-color: var(--success);
            color: var(--success);
        }

        .badge.warning {
            background: #FFEDD5;
            border-color: var(--warning);
            color: var(--warning);
        }

        /* MAIN CONTAINER & ACTIONS */
        .container {
            padding: 2rem 3rem;
        }

        .top-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
            gap: 1.25rem;
        }

        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 25rem;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--card-bg);
            outline: none;
            color: var(--text-dark);
            font-size: 0.95rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.25);
        }

        .search-box .ri-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9CA3AF;
            font-size: 1.3rem;
        }

        .filters {
            display: flex;
            gap: 0.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9375rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-filter {
            background: var(--card-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            box-shadow: none;
        }

        .btn-filter:hover {
            background: #F3F4F6;
        }

        .btn-filter.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3);
        }

        /* TABLE */
        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            min-width: 800px;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        th,
        td {
            padding: 1rem 1.25rem;
            text-align: left;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: #F9FAFB;
            font-weight: 600;
            color: var(--text-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover {
            background: #F9FBFD;
        }

        thead tr:first-child th:first-child {
            border-top-left-radius: var(--radius-lg);
        }

        thead tr:first-child th:last-child {
            border-top-right-radius: var(--radius-lg);
        }

        /* Status Chip */
        .status-chip {
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-block;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: #D1FAE5;
            color: var(--success);
        }

        .status-inactive {
            background: #FFEDD5;
            color: var(--warning);
        }

        /* Action Buttons */
        .action-btns {
            display: flex;
            gap: 0.25rem;
        }

        .icon-btn {
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: 0.3s;
        }

        .icon-btn .ri-icon {
            font-size: 1.2rem;
            color: #6B7280;
        }

        .icon-btn:hover {
            background: #F3F4F6;
            transform: translateY(-1px);
        }

        /* MODAL & MESSAGE MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 1.25rem;
            width: 90%;
            max-width: 48rem;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        #messageModal .modal-content {
            max-width: 25rem;
            padding: 1.5rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        #messageModal .modal-header {
            border-bottom: none;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .modal-header h2, #messageModal .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .close-btn {
            cursor: pointer;
            font-size: 2rem;
            color: #9CA3AF;
            transition: 0.2s;
        }
        
        #messageModal .close-btn {
            font-size: 1.5rem;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.3rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            outline: none;
            font-size: 1rem;
            background: #F9FAFB;
            color: var(--text-dark);
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
            background: var(--card-bg);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        .form-actions {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-secondary {
            background: #E5E7EB;
            color: #4B5563;
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: #D1D5DB;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* RESPONSIVENESS (Media Queries) */
        @media (max-width: 900px) {
            .navbar {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .container {
                padding: 1.5rem;
            }

            .top-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }

            .filters {
                justify-content: space-around;
                width: 100%;
            }

            .filters .btn {
                flex-grow: 1;
            }
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
        import { firebaseConfig } from '../Database/Database.js'; 

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let schoolData = [];
        let editUserId = null;
        let currentFilter = "ALL";
        const byId = id => document.getElementById(id);

        async function generateUserId() {
            return "ENR" + Math.floor(1000 + Math.random() * 9000);
        }

        const generatePassword = () => Math.random().toString(36).substring(2, 10).toUpperCase();
        
        // --- Custom Message Modal Functions (Replaces alert/confirm) ---

        function openMessageModal(title, message, isConfirm = false, onConfirm = null) {
            const modal = byId("messageModal");
            const titleEl = byId("messageTitle");
            const textEl = byId("messageText");
            const buttonsEl = byId("messageButtons");

            titleEl.textContent = title;
            textEl.textContent = message;
            buttonsEl.innerHTML = '';

            const closeBtn = document.createElement('button');
            closeBtn.className = "btn btn-secondary";
            closeBtn.textContent = isConfirm ? 'Cancel' : 'Close';
            closeBtn.onclick = closeMessageModal;
            buttonsEl.appendChild(closeBtn);

            if (isConfirm) {
                const confirmBtn = document.createElement('button');
                // Use red color for delete confirmation
                confirmBtn.className = "btn btn-primary bg-red-600 hover:bg-red-700"; 
                confirmBtn.textContent = 'Confirm Delete';
                confirmBtn.onclick = () => {
                    closeMessageModal();
                    if (onConfirm) onConfirm();
                };
                buttonsEl.appendChild(confirmBtn);
            }

            modal.style.display = "flex";
            document.body.style.overflow = "hidden";
        }

        function closeMessageModal() {
            byId("messageModal").style.display = "none";
            document.body.style.overflow = "auto";
        }
        
        // --- Main Modal Functions ---

        function openModal() {
            byId("userModal").style.display = "flex";
            document.body.style.overflow = "hidden";
            // Update modal title for edit/add
            byId("modalTitle").textContent = editUserId ? "Edit School Details" : "Add New School";
        }

        function closeModal() {
            byId("userModal").style.display = "none";
            document.body.style.overflow = "auto";
            clearForm();
        }

        function clearForm() {
            byId("name").value = "";
            byId("address").value = "";
            byId("phone").value = "";
            byId("userid").value = "";
            byId("password").value = "";
            byId("status").value = "ACTIVE";
            editUserId = null;
        }

        function fetchData() {
            const schoolsRef = ref(db, "schools");
            onValue(schoolsRef, (snapshot) => {
                const data = snapshot.exists() ? snapshot.val() : {};
                // Convert object of objects to array of objects for easier processing
                schoolData = Object.keys(data).map(key => data[key]);
                updateCounts();
                renderTable(schoolData);
            }, (error) => {
                console.error("Firebase Read Error:", error);
                openMessageModal("Error", "Data fetching error: " + error.message);
            });
        }

        function updateCounts() {
            const total = schoolData.length;
            const active = schoolData.filter(r => r.status === "ACTIVE").length;
            const inactive = total - active;
            byId("userCount").innerText = total;
            byId("activeCount").innerText = active;
            byId("inactiveCount").innerText = inactive;
        }

        function renderTable(data) {
            const tbody = byId("tableBody");
            tbody.innerHTML = "";
            
            const filteredData = data.filter(row => currentFilter === "ALL" || row.status === currentFilter);

            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color: var(--text-light);">No records found matching the criteria.</td></tr>`;
                return;
            }

            filteredData.forEach(row => {
                const statusClass = row.status === "ACTIVE" ? "status-active" : "status-inactive";
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${row.name}</td>
                    <td>${row.address}</td>
                    <td>${row.phone}</td>
                    <td>${row.userid}</td>
                    <td>${row.password}</td>
                    <td><span class="status-chip ${statusClass}">${row.status}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="icon-btn" onclick='window.editRow("${row.userid}")' title="Edit"><i class="ri-edit-line ri-icon"></i></button>
                            <button class="icon-btn" onclick='window.deleteRow("${row.userid}")' title="Delete"><i class="ri-delete-bin-line ri-icon"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function saveUser() {
            try {
                const name = byId("name").value.trim().toUpperCase();
                const address = byId("address").value.trim().toUpperCase();
                const phone = byId("phone").value.trim();
                const status = byId("status").value;
                let userid = byId("userid").value.trim();
                let password = byId("password").value.trim();
                const isEditing = !!editUserId;

                if (!name || !address || !phone) {
                    openMessageModal("Missing Fields", "⚠️ Please fill all required fields (Name, Address, Phone).");
                    return;
                }

                // Check for duplicates only if adding, or if name/phone changed during editing
                const duplicate = schoolData.find(r =>
                    (r.name === name || r.phone === phone) && r.userid !== editUserId
                );
                
                if (duplicate) {
                    openMessageModal("Duplicate Error", "❌ Duplicate entry! Same School Name or Phone already exists.");
                    return;
                }

                const oldSchoolData = isEditing ? schoolData.find(r => r.userid === editUserId) : null;
                const oldName = oldSchoolData ? oldSchoolData.name : null;
                const nameChanged = isEditing && name !== oldName;

                let updates = {};
                
                if (!isEditing) {
                    if (!userid) userid = await generateUserId();
                    if (!password) password = generatePassword();
                    
                    const newSchoolData = { name, address, phone, userid, password, status };
                    // Set data using user ID as the key
                    updates[`/schools/${userid}`] = newSchoolData; 
                } else {
                    userid = editUserId;
                    
                    // Maintain existing password if not changed in form
                    if (!password) password = oldSchoolData.password;

                    const baseUpdate = { name, address, phone, userid, password, status };
                    updates[`/schools/${userid}`] = baseUpdate;
                    
                    if (nameChanged) {
                        /* Multi-Path Update Logic (Placeholder)
                        If school name needs to be updated in other nodes (students, teachers, etc.), 
                        add those paths to the 'updates' object here.
                        */
                       console.log(`Name changed from ${oldName} to ${name}. Multi-path updates would go here.`);
                    }
                }
                
                await update(ref(db, '/'), updates);

                openMessageModal("Success", `✅ School ${isEditing ? 'updated' : 'added'} successfully!`);
                closeModal();

            } catch (err) {
                console.error("Save Error:", err);
                openMessageModal("Error", "❌ Error saving data. Please try again.");
            }
        }
        
        window.editRow = function (userid) {
            const row = schoolData.find(r => r.userid === userid);
            if (!row) {
                openMessageModal("Error", "❌ School record not found.");
                return;
            }
            byId("name").value = row.name;
            byId("address").value = row.address;
            byId("phone").value = row.phone;
            byId("userid").value = row.userid;
            byId("password").value = row.password;
            byId("status").value = row.status;
            editUserId = row.userid;
            openModal();
        }

        window.deleteRow = function (userid) {
            const row = schoolData.find(r => r.userid === userid);
            if (!row) {
                openMessageModal("Error", "❌ School record not found.");
                return;
            }

            const confirmAction = async () => {
                try {
                    await remove(ref(db, "schools/" + userid));
                    openMessageModal("Success", "✅ School deleted successfully.");
                } catch (err) {
                    console.error("Delete Error:", err);
                    openMessageModal("Error", "❌ Error deleting data. Please try again.");
                }
            };

            // Use custom modal for confirmation (Replacing window.confirm)
            openMessageModal(
                "Confirm Deletion",
                `Are you sure you want to delete this school record (ID: ${userid})? This action cannot be undone.`,
                true, // isConfirm: true
                confirmAction
            );
        }

        window.searchTable = function () {
            const term = byId("searchBox").value.toLowerCase().trim();
            const filtered = schoolData.filter(r =>
                r.name.toLowerCase().includes(term) ||
                r.address.toLowerCase().includes(term) ||
                r.phone.includes(term) ||
                r.userid.toLowerCase().includes(term)
            );
            renderTable(filtered);
        }

        window.filterTable = function (filter) {
            currentFilter = filter;
            document.querySelectorAll(".btn-filter").forEach(btn => btn.classList.remove("active"));
            byId("btn-" + filter).classList.add("active");
            // Re-render the table with the filtered view
            renderTable(schoolData.filter(row => currentFilter === "ALL" || row.status === currentFilter));
        }
        
        window.onload = () => { fetchData(); filterTable("ALL"); };
        
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveUser = saveUser;
        window.closeMessageModal = closeMessageModal;

    </script>
</head>

<body>
    <div class="navbar">
        <h1>School Manager</h1>
        <div class="badges">
            <div class="badge info"><i class="ri-group-line ri-icon"></i><span id="userCount">0</span> Total</div>
            <div class="badge success"><i class="ri-checkbox-circle-line ri-icon"></i><span id="activeCount">0</span>
                Active</div>
            <div class="badge warning"><i class="ri-pause-circle-line ri-icon"></i><span id="inactiveCount">0</span>
                Inactive</div>
        </div>
    </div>

    <div class="container">
        <div class="top-actions">
            <div class="search-box">
                <i class="ri-search-line ri-icon"></i>
                <input id="searchBox" placeholder="Search by name, phone or ID..." oninput="searchTable()" />
            </div>
            <div class="filters">
                <button id="btn-ALL" class="btn btn-filter active" onclick="filterTable('ALL')">All</button>
                <button id="btn-ACTIVE" class="btn btn-filter" onclick="filterTable('ACTIVE')">Active</button>
                <button id="btn-INACTIVE" class="btn btn-filter" onclick="filterTable('INACTIVE')">Inactive</button>
            </div>
            <button class="btn btn-primary" onclick="window.openModal()">
                <i class="ri-add-line ri-icon"></i> Add New School
            </button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>School Name</th>
                        <th>Address</th>
                        <th>Phone</th>
                        <th>User ID</th>
                        <th>Password</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="7" style="text-align:center; padding:30px;">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- MAIN CRUD MODAL -->
    <div class="modal" id="userModal" onclick="if(event.target.id === 'userModal') closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">School Details Form</h2>
                <span class="close-btn" onclick="window.closeModal()">&times;</span>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="name">School Name *</label>
                    <input id="name" placeholder="Enter school name" required />
                </div>
                <div class="form-group">
                    <label for="address">Address *</label>
                    <input id="address" placeholder="Enter address" required />
                </div>
                <div class="form-group">
                    <label for="phone">Phone *</label>
                    <input id="phone" type="tel" pattern="[0-9]*" placeholder="Enter phone number" required />
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status">
                        <option value="ACTIVE">ACTIVE</option>
                        <option value="INACTIVE">INACTIVE</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userid">User ID (ENRXXXX)</label>
                    <input id="userid" placeholder="Auto-generated" readonly />
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input id="password" placeholder="Auto-generated if empty" />
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="window.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="window.saveUser()">Save Details</button>
            </div>
        </div>
    </div>
    
    <!-- CUSTOM MESSAGE/CONFIRMATION MODAL -->
    <div class="modal" id="messageModal" onclick="if(event.target.id === 'messageModal') closeMessageModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageTitle" class="text-xl font-bold">Message</h3>
                <span class="close-btn" onclick="window.closeMessageModal()">&times;</span>
            </div>
            <p id="messageText" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end gap-3" id="messageButtons">
                <!-- Buttons are inserted by openMessageModal function -->
            </div>
        </div>
    </div>
</body>

</html>
